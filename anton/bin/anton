#!/bin/bash
set -euo pipefail

# â”€â”€ Anton CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Named after Gilfoyle's server. A multi-agent framework for
# building web apps with Claude Code â€” Silicon Valley Edition.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

TEAM_DIR="$(cd "$(dirname "$0")/.." && pwd)"
source "$TEAM_DIR/lib/checkpoint.sh"
source "$TEAM_DIR/lib/notify.sh"
source "$TEAM_DIR/lib/git-helpers.sh"

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

load_config() {
  if [ ! -f .agent-config.json ]; then
    echo "âŒ No .agent-config.json found. Run 'anton init' first."
    exit 1
  fi
}

get_config() {
  jq -r "$1" .agent-config.json
}

render_template() {
  local template="$1"
  local project_type="${2:-}"
  local team_dir_escaped="${TEAM_DIR//\//\\/}"

  sed \
    -e "s|{{TEAM_DIR}}|$TEAM_DIR|g" \
    -e "s|{{PROJECT_TYPE}}|$project_type|g" \
    -e "s|{{PROJECT_DIR}}|$(pwd)|g" \
    "$template"
}

# â”€â”€ Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_init() {
  local project_dir="${1:-.}"
  local project_type="${2:-react-ghpages}"

  # Validate project type
  if [ ! -f "$TEAM_DIR/templates/project-types/$project_type.md" ]; then
    echo "âŒ Unknown project type: $project_type"
    echo "   Available types:"
    cmd_list_types
    exit 1
  fi

  mkdir -p "$project_dir/docs"

  # Copy and configure agent config
  jq --arg type "$project_type" \
     --arg team "$TEAM_DIR" \
     '.projectType = $type | .teamDir = $team' \
     "$TEAM_DIR/templates/agent-config.json" > "$project_dir/.agent-config.json"

  # Copy CLAUDE.md (project-level instructions for Claude Code)
  cp "$TEAM_DIR/templates/CLAUDE.md" "$project_dir/CLAUDE.md"

  # Copy gitignore
  cp "$TEAM_DIR/templates/.gitignore-project" "$project_dir/.gitignore" 2>/dev/null || true

  echo "âœ… Initialized anton project"
  echo "   Type:   $project_type"
  echo "   Dir:    $project_dir"
  echo "   Config: $project_dir/.agent-config.json"
  echo ""
  echo "Next steps:"
  echo "   cd $project_dir"
  echo "   anton interactive    # gather requirements"
  echo "   anton build --detach # autonomous build"
}

cmd_interactive() {
  load_config
  local model=$(get_config '.phases.interactive.model')
  local project_type=$(get_config '.projectType')

  # Compose system prompt from PM agent + project type context
  local system_prompt=$(cat "$TEAM_DIR/prompts/pm.md")
  local type_context=$(cat "$TEAM_DIR/templates/project-types/$project_type.md")

  echo "ğŸ—£ï¸  Starting interactive session ($model)"
  echo "   Project type: $project_type"
  echo ""

  claude --model "$model" --system-prompt "$system_prompt

## Project Type Context
$type_context

## Anton Location
The reusable agent prompts are at: $TEAM_DIR/prompts/
Read these when you need to understand what each agent role does.

## Your Goal
Guide the user through requirements gathering. When complete, save:
- ./docs/prd.md (product requirements document)
- ./docs/architecture.md (system design, component tree, tech choices)
- ./docs/tasks.md (task dependency graph for the build phase)

Make sure tasks.md clearly marks which tasks can run in parallel
and which have dependencies." \
    "Hi! I'm ready to start building something. Let's go!"
}

cmd_build() {
  load_config
  local model=$(get_config '.phases.build.model')
  local project_type=$(get_config '.projectType')
  local detach=false
  local step=false

  # Parse flags
  for arg in "$@"; do
    case "$arg" in
      --detach) detach=true ;;
      --step)   step=true ;;
    esac
  done

  # --step flag overrides config to enable pauseBetweenPhases for this run
  if [ "$step" = true ]; then
    local tmp=$(jq '.build.pauseBetweenPhases = true' .agent-config.json)
    echo "$tmp" > .agent-config.json
  fi

  # Check prerequisites
  if [ ! -f ./docs/prd.md ]; then
    echo "âŒ No PRD found at ./docs/prd.md"
    echo "   Run 'anton interactive' first to gather requirements."
    exit 1
  fi

  # Assemble build prompt
  local prompt=$(render_template "$TEAM_DIR/templates/build-prompt.md" "$project_type")
  local type_context=$(cat "$TEAM_DIR/templates/project-types/$project_type.md")
  prompt="$prompt

## Project Type
$type_context"

  if [ "$detach" = true ]; then
    local ntfy_topic=$(get_config '.notifications.ntfyTopic // empty')

    echo "ğŸš€ Starting autonomous build ($model) â€” detached"
    [ "$step" = true ] && echo "   â¸ï¸  Step mode: will pause after each phase"

    nohup claude --model "$model" \
      -p "$prompt" \
      > build.log 2>&1 &

    local build_pid=$!
    echo $build_pid > .build.pid
    echo "   PID: $build_pid"
    echo "   Log: $(pwd)/build.log"
    echo "   Safe to disconnect."

    if [ -n "$ntfy_topic" ]; then
      watch_and_notify "$build_pid" "$ntfy_topic" "build.log" &
      echo "   Notifications: ntfy.sh/$ntfy_topic"
    fi
  else
    echo "ğŸš€ Starting autonomous build ($model)"
    [ "$step" = true ] && echo "   â¸ï¸  Step mode: will pause after each phase"
    claude --model "$model" "$prompt"
  fi
}

cmd_resume() {
  load_config
  local model=$(get_config '.phases.build.model')
  local detach=false

  if [ "${1:-}" = "--detach" ]; then
    detach=true
  fi

  if [ ! -f .agent-state.json ]; then
    echo "âŒ No .agent-state.json found â€” nothing to resume."
    echo "   Run 'anton build' to start a build first."
    exit 1
  fi

  local prompt=$(render_template "$TEAM_DIR/templates/resume-prompt.md")

  if [ "$detach" = true ]; then
    local ntfy_topic=$(get_config '.notifications.ntfyTopic // empty')

    echo "ğŸ”„ Resuming build ($model) â€” detached"

    nohup claude --model "$model" \
      -p "$prompt" \
      > build.log 2>&1 &

    local build_pid=$!
    echo $build_pid > .build.pid
    echo "   PID: $build_pid"

    if [ -n "$ntfy_topic" ]; then
      watch_and_notify "$build_pid" "$ntfy_topic" "build.log" &
    fi
  else
    echo "ğŸ”„ Resuming build ($model)"
    claude --model "$model" "$prompt"
  fi
}

cmd_review() {
  load_config
  local model=$(get_config '.phases.interactive.model')

  echo "ğŸ” Starting review session ($model)"
  claude --model "$model" \
    "You are reviewing a completed autonomous build. Read these files:
- HANDOFF.md (build summary)
- .agent-state.json (checkpoint state)
- git log --oneline (recent commits)
- ./docs/prd.md (original requirements)

Walk the user through what was built, flag any concerns, and ask
if they want any changes. If changes are needed, make them directly."
}

cmd_status() {
  load_config
  show_status
}

cmd_list_types() {
  echo "Available project types:"
  for f in "$TEAM_DIR/templates/project-types/"*.md; do
    local name=$(basename "$f" .md)
    local desc=$(head -1 "$f" | sed 's/^# //')
    printf "  %-20s %s\n" "$name" "$desc"
  done
}

cmd_logs() {
  if [ -f build.log ]; then
    tail -f build.log
  else
    echo "No build.log found."
  fi
}

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

case "${1:-help}" in
  init)         cmd_init "${2:-}" "${3:-}" ;;
  interactive)  cmd_interactive ;;
  build)        shift; cmd_build "$@" ;;
  resume)       cmd_resume "${2:-}" ;;
  review)       cmd_review ;;
  status)       cmd_status ;;
  logs)         cmd_logs ;;
  list-types)   cmd_list_types ;;
  help|--help|-h)
    echo "âš™ï¸  anton â€” Multi-agent web app builder (Silicon Valley Edition)"
    echo "   Named after Gilfoyle's server. It runs autonomously and judges your code."
    echo ""
    echo "Usage: anton <command> [options]"
    echo ""
    echo "Setup:"
    echo "  init <dir> <type>     Scaffold new project (default: react-ghpages)"
    echo "  list-types            Show available project types"
    echo ""
    echo "Workflow:"
    echo "  interactive           Requirements gathering session (you + Sonnet)"
    echo "  build [--detach] [--step]  Autonomous build phase (Opus)"
    echo "  resume [--detach]     Resume interrupted build"
    echo "  review                Interactive review of completed build"
    echo ""
    echo "Monitoring:"
    echo "  status                Check build progress"
    echo "  logs                  Tail the build log"
    echo ""
    echo "Project types: $(ls "$TEAM_DIR/templates/project-types/" | sed 's/\.md//g' | tr '\n' ', ' | sed 's/,$//')"
    ;;
  *)
    echo "Unknown command: $1 (run 'anton help' for usage)"
    exit 1
    ;;
esac
